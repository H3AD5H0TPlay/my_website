---
// Mobile menu will be populated dynamically via JavaScript from the language store
---

<div class="md:hidden">
  <button
    id="menu-toggle"
    class="fixed top-4 right-4 p-2 text-cyber-red hover:text-cyber-red-bright transition-all duration-300 hover:scale-105 z-[70]"
    aria-label="Toggle Menu"
    aria-expanded="false"
    aria-controls="mobile-menu"
  >
    <div class="menu-icon w-6 h-6 relative">
      <span class="menu-line absolute h-0.5 w-full bg-current transform transition-all duration-300 origin-center top-0 left-0"></span>
      <span class="menu-line absolute h-0.5 w-full bg-current transform transition-all duration-300 origin-center top-[10px] left-0"></span>
      <span class="menu-line absolute h-0.5 w-full bg-current transform transition-all duration-300 origin-center top-[20px] left-0"></span>
    </div>
  </button>

  <nav
    id="mobile-menu"
    class="fixed inset-0 z-[60] transform translate-x-full transition-all duration-500 ease-out"
  >
    <!-- Background layers -->
    <div class="absolute inset-0 bg-black/95"></div>
    <div class="absolute inset-0 backdrop-blur-xl"></div>
    <div class="absolute inset-0 bg-gradient-to-br from-cyber-red/10 via-transparent to-cyber-red/5"></div>
    
  <div class="relative z-10 h-full flex flex-col pt-20 px-8">
      <!-- Unified liquid glass menu panel -->
      <div class="relative w-full mt-8 rounded-2xl bg-black/40 backdrop-blur-md overflow-hidden">
        <!-- Liquid glass effects -->
        <div class="absolute inset-0 bg-gradient-to-br from-cyber-red/20 to-transparent"></div>
        <div class="absolute -inset-[150%] bg-gradient-to-br from-cyber-red/5 via-transparent to-cyber-red/10 animate-slow-spin"></div>
        
        <!-- Menu items - populated dynamically -->
        <ul id="mobile-menu-items" class="relative z-10 w-full p-4">
          <!-- Items will be populated via JavaScript -->
        </ul>
      </div>
    </div>
  </nav>
  <!-- Safelist Tailwind classes used via JS -->
  <span class="hidden opacity-100 translate-x-0"></span>
</div>

<style>
  .menu-icon .menu-line {
    transition: transform 0.3s ease, opacity 0.3s ease, width 0.3s ease;
  }
  
  .menu-icon.active .menu-line:first-child {
    transform: rotate(45deg) translateY(13px);
  }
  
  .menu-icon.active .menu-line:nth-child(2) {
    opacity: 0;
    transform: translateX(-10px);
  }
  
  .menu-icon.active .menu-line:last-child {
    transform: rotate(-45deg) translateY(-13px);
  }

  /* Reveal menu items when menu is open */
  #mobile-menu:not(.translate-x-full) .menu-list-item a {
    opacity: 1 !important;
    transform: translateX(0) !important;
  }

  @keyframes slow-spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .animate-slow-spin {
    animation: slow-spin 20s linear infinite;
  }
</style>

<script>
  import { currentTranslations } from '../stores/languageStore';

  (function initMobileMenu() {
    const setup = () => {
      const menuToggle = document.getElementById('menu-toggle');
      const menuIcon = menuToggle?.querySelector('.menu-icon');
      const mobileMenu = document.getElementById('mobile-menu');
      const menuItemsList = document.getElementById('mobile-menu-items');

      if (!menuToggle || !mobileMenu || !menuItemsList) return;

      let isAnimating = false;
      let menuLinks: NodeListOf<HTMLAnchorElement> | null = null;

      // Generate menu items from current translations
      function generateMenuItems(translations: any) {
        if (!menuItemsList) return;

        const menuItems = [
          { href: '#about', key: 'about' },
          { href: '#experience', key: 'experience' },
          { href: '#skills', key: 'skills' },
          { href: '#projects', key: 'projects' },
          { href: '#contact', key: 'contact' }
        ];

        menuItemsList.innerHTML = '';

        menuItems.forEach((item, index) => {
          const li = document.createElement('li');
          li.className = 'menu-list-item mb-6 last:mb-0';

          const a = document.createElement('a');
          a.href = item.href;
          a.className = 'block text-2xl font-cyber text-white hover:text-cyber-red transition-all duration-300 relative group opacity-0 translate-x-8';
          a.style.transitionDelay = `${index * 100}ms`;

          const div = document.createElement('div');
          div.className = 'px-6 py-3 relative group-hover:bg-black/20 rounded-xl transition-all duration-300';

          const span = document.createElement('span');
          span.className = 'relative z-10 flex items-center';

          const arrow = document.createElement('span');
          arrow.className = 'text-cyber-red mr-3 opacity-0 group-hover:opacity-100 transition-all duration-300 transform -translate-x-2 group-hover:translate-x-0';
          arrow.textContent = '>';

          const text = document.createElement('span');
          text.textContent = translations.nav?.[item.key] || translations[item.key]?.title || item.key;

          span.appendChild(arrow);
          span.appendChild(text);
          div.appendChild(span);
          a.appendChild(div);
          li.appendChild(a);
          menuItemsList.appendChild(li);
        });

        // Update menu links reference and setup click handlers
        setupMenuLinks();
      }

      function setupMenuLinks() {
        if (!mobileMenu) return;
        const currentLinks = mobileMenu.querySelectorAll('a');
        currentLinks.forEach(link => {
          link.addEventListener('click', toggleMenu);
        });
      }      /** @param {boolean} visible */
      function showLinks() {
        const currentLinks = mobileMenu?.querySelectorAll('a');
        if (!currentLinks) return;
        currentLinks.forEach((link) => {
          link.classList.remove('opacity-0', 'translate-x-8');
          link.classList.add('opacity-100', 'translate-x-0');
        });
      }

      function hideLinks() {
        const currentLinks = mobileMenu?.querySelectorAll('a');
        if (!currentLinks) return;
        currentLinks.forEach((link) => {
          link.classList.add('opacity-0', 'translate-x-8');
          link.classList.remove('opacity-100', 'translate-x-0');
        });
      }

      function toggleMenu() {
        if (isAnimating || !mobileMenu || !menuToggle) return;
        isAnimating = true;

        const isOpening = mobileMenu.classList.contains('translate-x-full');

        if (isOpening) {
          menuIcon?.classList.add('active');
          setTimeout(() => {
            mobileMenu.classList.remove('translate-x-full');
            document.body.classList.add('overflow-hidden');
            menuToggle.setAttribute('aria-expanded', 'true');
            showLinks();
          }, 50);
        } else {
          mobileMenu.classList.add('translate-x-full');
          document.body.classList.remove('overflow-hidden');
          setTimeout(() => {
            menuIcon?.classList.remove('active');
          }, 300);
          menuToggle.setAttribute('aria-expanded', 'false');
          hideLinks();
        }

        setTimeout(() => {
          isAnimating = false;
        }, 500);
      }

      // Initialize menu items and subscribe to language changes
      currentTranslations.subscribe((translations) => {
        generateMenuItems(translations);
      });

      // Generate initial menu items
      generateMenuItems(currentTranslations.get());

      menuToggle.addEventListener('click', toggleMenu);

      // Close on Escape for accessibility
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && mobileMenu && !mobileMenu.classList.contains('translate-x-full')) {
          toggleMenu();
        }
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setup);
    } else {
      setup();
    }
  })();
</script>